/*
    YARA Rules for Malware Detection in Source Code
    
    These rules detect malicious patterns in source code repositories.
    Focuses on detecting malware behaviors in scripts and source files.
*/

// ============================================================================
// CREDENTIAL THEFT
// ============================================================================

rule credential_stealer {
    meta:
        description = "Detects credential stealing patterns"
        severity = "critical"
        category = "credential_theft"
        
    strings:
        $pass1 = "password" nocase
        $pass2 = "passwd" nocase
        $pass3 = "credential" nocase
        
        $steal1 = "steal" nocase
        $steal2 = "harvest" nocase
        $steal3 = "extract" nocase
        
        $browser1 = "chrome" nocase
        $browser2 = "firefox" nocase
        $browser3 = "browser" nocase
        
    condition:
        ($pass1 or $pass2 or $pass3) and 
        ($steal1 or $steal2 or $steal3) and
        ($browser1 or $browser2 or $browser3)
}

rule password_dumper {
    meta:
        description = "Detects password dumping utilities"
        severity = "critical"
        category = "credential_theft"
        
    strings:
        $dump1 = "mimikatz" nocase
        $dump2 = "lsass" nocase
        $dump3 = "sam.sav" nocase
        $dump4 = "procdump" nocase
        $dump5 = "secretsdump" nocase
        
        $action1 = "dump" nocase
        $action2 = "extract" nocase
        
    condition:
        any of ($dump*) or (any of ($action*) and #action1 > 2)
}

// ============================================================================
// REVERSE SHELLS & BACKDOORS
// ============================================================================

rule reverse_shell {
    meta:
        description = "Detects reverse shell patterns"
        severity = "critical"
        category = "backdoor"
        
    strings:
        $socket1 = "socket.socket" nocase
        $socket2 = "socket.connect" nocase
        $socket3 = "Socket" nocase
        
        $shell1 = "/bin/sh" nocase
        $shell2 = "/bin/bash" nocase
        $shell3 = "cmd.exe" nocase
        $shell4 = "powershell" nocase
        
        $exec1 = "subprocess.Popen" nocase
        $exec2 = "os.system" nocase
        $exec3 = "exec(" nocase
        $exec4 = "eval(" nocase
        
    condition:
        (any of ($socket*)) and (any of ($shell*) or any of ($exec*))
}

rule bind_shell {
    meta:
        description = "Detects bind shell patterns"
        severity = "critical"
        category = "backdoor"
        
    strings:
        $bind1 = "socket.bind" nocase
        $bind2 = "socket.listen" nocase
        $bind3 = "socket.accept" nocase
        
        $shell1 = "/bin/sh"
        $shell2 = "cmd.exe"
        $shell3 = "powershell"
        
    condition:
        2 of ($bind*) and any of ($shell*)
}

rule webshell {
    meta:
        description = "Detects web shell patterns"
        severity = "critical"
        category = "backdoor"
        
    strings:
        $php1 = "<?php"
        $php2 = "eval($_"
        $php3 = "system($_"
        $php4 = "exec($_"
        $php5 = "passthru($_"
        $php6 = "shell_exec($_"
        
        $asp1 = "execute request"
        $asp2 = "eval request"
        
        $generic1 = "cmd" nocase
        $generic2 = "command" nocase
        
    condition:
        ($php1 and any of ($php2,$php3,$php4,$php5,$php6)) or
        any of ($asp*) or
        (any of ($generic*) and any of ($php*))
}

// ============================================================================
// RANSOMWARE
// ============================================================================

rule ransomware_behavior {
    meta:
        description = "Detects ransomware-like behavior"
        severity = "critical"
        category = "ransomware"
        
    strings:
        $encrypt1 = "encrypt" nocase
        $encrypt2 = "cipher" nocase
        $encrypt3 = "aes" nocase
        $encrypt4 = "rsa" nocase
        
        $ransom1 = "ransom" nocase
        $ransom2 = "payment" nocase
        $ransom3 = "bitcoin" nocase
        $ransom4 = "decrypt" nocase
        $ransom5 = "victim" nocase
        
        $file1 = "walkdir" nocase
        $file2 = "listdir" nocase
        $file3 = "glob" nocase
        
    condition:
        (any of ($encrypt*)) and 
        (2 of ($ransom*)) and
        (any of ($file*))
}

rule file_encryptor {
    meta:
        description = "Detects file encryption functionality"
        severity = "high"
        category = "ransomware"
        
    strings:
        $crypto1 = "Crypto.Cipher" nocase
        $crypto2 = "cryptography" nocase
        $crypto3 = "AES.new" nocase
        $crypto4 = "Cipher.new" nocase
        
        $loop1 = "for file in" nocase
        $loop2 = "walk(" nocase
        $loop3 = "glob(" nocase
        
        $write1 = ".write(" nocase
        $write2 = "open(" nocase
        
    condition:
        any of ($crypto*) and any of ($loop*) and any of ($write*)
}

// ============================================================================
// KEYLOGGERS
// ============================================================================

rule keylogger {
    meta:
        description = "Detects keystroke logging"
        severity = "critical"
        category = "spyware"
        
    strings:
        $hook1 = "SetWindowsHookEx" nocase
        $hook2 = "GetAsyncKeyState" nocase
        $hook3 = "keyboard.hook" nocase
        $hook4 = "pynput" nocase
        
        $key1 = "keyboard" nocase
        $key2 = "keystroke" nocase
        $key3 = "keypress" nocase
        
        $log1 = "log" nocase
        $log2 = "record" nocase
        $log3 = "capture" nocase
        
    condition:
        (any of ($hook*)) or
        ((any of ($key*)) and (any of ($log*)) and #log1 > 2)
}

// ============================================================================
// PROCESS INJECTION & EVASION
// ============================================================================

rule process_injection {
    meta:
        description = "Detects process injection techniques"
        severity = "high"
        category = "execution"
        
    strings:
        $inject1 = "VirtualAllocEx" nocase
        $inject2 = "WriteProcessMemory" nocase
        $inject3 = "CreateRemoteThread" nocase
        $inject4 = "NtCreateThreadEx" nocase
        
        $python1 = "ctypes.windll" nocase
        $python2 = "kernel32" nocase
        
    condition:
        2 of ($inject*) or (any of ($inject*) and any of ($python*))
}

rule anti_debugging {
    meta:
        description = "Detects anti-debugging techniques"
        severity = "high"
        category = "evasion"
        
    strings:
        $debug1 = "IsDebuggerPresent" nocase
        $debug2 = "CheckRemoteDebuggerPresent" nocase
        $debug3 = "NtQueryInformationProcess" nocase
        $debug4 = "debugger" nocase
        
        $vm1 = "VMware" nocase
        $vm2 = "VirtualBox" nocase
        $vm3 = "QEMU" nocase
        $vm4 = "virtual machine" nocase
        
        $detect1 = "detect" nocase
        $detect2 = "check" nocase
        
    condition:
        (any of ($debug*)) or
        ((any of ($vm*)) and (any of ($detect*)))
}

rule sandbox_evasion {
    meta:
        description = "Detects sandbox evasion techniques"
        severity = "high"
        category = "evasion"
        
    strings:
        $sleep1 = "sleep(" nocase
        $sleep2 = "time.sleep" nocase
        $sleep3 = "Sleep(" nocase
        
        $check1 = "GetTickCount" nocase
        $check2 = "QueryPerformanceCounter" nocase
        
        $user1 = "GetUserName" nocase
        $user2 = "GetComputerName" nocase
        
    condition:
        (any of ($sleep*) and #sleep1 > 5) or
        (any of ($check*)) or
        (2 of ($user*))
}

// ============================================================================
// PERSISTENCE
// ============================================================================

rule persistence_registry {
    meta:
        description = "Detects registry persistence mechanisms"
        severity = "high"
        category = "persistence"
        
    strings:
        $reg1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg2 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase
        $reg3 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg4 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        
        $func1 = "RegSetValueEx" nocase
        $func2 = "winreg" nocase
        $func3 = "reg add" nocase
        
    condition:
        any of ($reg*) and any of ($func*)
}

rule persistence_scheduled_task {
    meta:
        description = "Detects scheduled task persistence"
        severity = "high"
        category = "persistence"
        
    strings:
        $schtask1 = "schtasks" nocase
        $schtask2 = "ScheduledTask" nocase
        $schtask3 = "Register-ScheduledTask" nocase
        
        $cron1 = "crontab" nocase
        $cron2 = "/etc/cron" nocase
        
    condition:
        any of them
}

// ============================================================================
// C2 COMMUNICATION
// ============================================================================

rule c2_communication {
    meta:
        description = "Detects command and control patterns"
        severity = "high"
        category = "c2"
        
    strings:
        $http1 = "http://" nocase
        $http2 = "https://" nocase
        
        $cmd1 = "command" nocase
        $cmd2 = "control" nocase
        $cmd3 = "beacon" nocase
        $cmd4 = "callback" nocase
        $cmd5 = "heartbeat" nocase
        
        $data1 = "exfiltrate" nocase
        $data2 = "upload" nocase
        $data3 = "download" nocase
        
        $base641 = "base64" nocase
        
    condition:
        (any of ($http*)) and 
        (any of ($cmd*)) and
        (any of ($data*) or $base641)
}

rule data_exfiltration {
    meta:
        description = "Detects data exfiltration patterns"
        severity = "high"
        category = "exfiltration"
        
    strings:
        $net1 = "requests.post" nocase
        $net2 = "urllib.request" nocase
        $net3 = "http.client" nocase
        $net4 = "socket.send" nocase
        
        $data1 = "json.dumps" nocase
        $data2 = "pickle.dumps" nocase
        $data3 = "base64.b64encode" nocase
        
        $file1 = "open(" nocase
        $file2 = "read(" nocase
        
    condition:
        any of ($net*) and any of ($data*) and any of ($file*)
}

// ============================================================================
// CRYPTO MINING
// ============================================================================

rule crypto_miner {
    meta:
        description = "Detects cryptocurrency mining"
        severity = "high"
        category = "crypto_miner"
        
    strings:
        $coin1 = "monero" nocase
        $coin2 = "xmrig" nocase
        $coin3 = "stratum" nocase
        $coin4 = "pool.minexmr" nocase
        $coin5 = "cryptonight" nocase
        
        $mining1 = "mining" nocase
        $mining2 = "miner" nocase
        $mining3 = "hashrate" nocase
        
    condition:
        any of ($coin*) or (2 of ($mining*))
}

// ============================================================================
// OBFUSCATION
// ============================================================================

rule code_obfuscation {
    meta:
        description = "Detects code obfuscation techniques"
        severity = "medium"
        category = "obfuscation"
        
    strings:
        $obf1 = "eval(" nocase
        $obf2 = "exec(" nocase
        $obf3 = "compile(" nocase
        
        $enc1 = "base64.b64decode" nocase
        $enc2 = "decode('hex')" nocase
        $enc3 = "unhexlify" nocase
        
        $dyn1 = "getattr(" nocase
        $dyn2 = "__import__" nocase
        
    condition:
        (any of ($obf*) and #obf1 > 3) or
        (any of ($enc*) and any of ($obf*)) or
        (2 of ($dyn*))
}

// ============================================================================
// NETWORK SCANNING
// ============================================================================

rule network_scanner {
    meta:
        description = "Detects network scanning functionality"
        severity = "medium"
        category = "reconnaissance"
        
    strings:
        $scan1 = "port scan" nocase
        $scan2 = "nmap" nocase
        $scan3 = "masscan" nocase
        
        $socket1 = "socket.connect" nocase
        $loop1 = "for port in range" nocase
        
        $net1 = "192.168" nocase
        $net2 = "10.0" nocase
        
    condition:
        any of ($scan*) or
        ($socket1 and $loop1) or
        (any of ($net*) and $socket1)
}

// ============================================================================
// SUSPICIOUS POWERSHELL
// ============================================================================

rule suspicious_powershell {
    meta:
        description = "Detects suspicious PowerShell patterns"
        severity = "high"
        category = "execution"
        
    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        
        $flag1 = "-EncodedCommand" nocase
        $flag2 = "-Enc" nocase
        $flag3 = "-ExecutionPolicy Bypass" nocase
        $flag4 = "-WindowStyle Hidden" nocase
        $flag5 = "-NoProfile" nocase
        
        $dl1 = "DownloadString" nocase
        $dl2 = "DownloadFile" nocase
        $dl3 = "Invoke-WebRequest" nocase
        $dl4 = "IWR" nocase
        
        $exec1 = "Invoke-Expression" nocase
        $exec2 = "IEX" nocase
        
    condition:
        (any of ($ps*)) and 
        (any of ($flag*) or any of ($dl*) or any of ($exec*))
}

// ============================================================================
// MALICIOUS SCRIPTS
// ============================================================================

rule malicious_python_script {
    meta:
        description = "Detects potentially malicious Python patterns"
        severity = "medium"
        category = "malware"
        
    strings:
        $py1 = "#!/usr/bin/env python"
        $py2 = "import os"
        $py3 = "import sys"
        
        $danger1 = "os.system" nocase
        $danger2 = "subprocess.call" nocase
        $danger3 = "eval(" nocase
        $danger4 = "exec(" nocase
        
        $net1 = "socket" nocase
        $net2 = "urllib" nocase
        $net3 = "requests" nocase
        
        $stealth1 = "hidden" nocase
        $stealth2 = "bypass" nocase
        
    condition:
        (any of ($py*)) and 
        (2 of ($danger*)) and
        (any of ($net*)) and
        (any of ($stealth*))
}

// ============================================================================
// JAVA MALWARE PATTERNS
// ============================================================================

rule java_command_execution {
    meta:
        description = "Detects Java command execution patterns"
        severity = "high"
        category = "code_execution"
        
    strings:
        $exec1 = "Runtime.getRuntime().exec" nocase
        $exec2 = "ProcessBuilder" nocase
        $exec3 = ".start()" nocase
        
        $danger1 = "cmd" nocase
        $danger2 = "/bin/sh" nocase
        $danger3 = "powershell" nocase
        
    condition:
        (any of ($exec*)) and (any of ($danger*))
}

rule java_reflection_abuse {
    meta:
        description = "Detects Java reflection for malicious purposes"
        severity = "medium"
        category = "code_execution"
        
    strings:
        $reflect1 = "Class.forName" nocase
        $reflect2 = "getDeclaredMethod" nocase
        $reflect3 = "setAccessible(true)" nocase
        $reflect4 = "invoke(" nocase
        
        $danger1 = "Runtime" nocase
        $danger2 = "ProcessBuilder" nocase
        
    condition:
        (2 of ($reflect*)) and (any of ($danger*))
}

rule java_unsafe_operations {
    meta:
        description = "Detects Java Unsafe API usage"
        severity = "high"
        category = "memory_manipulation"
        
    strings:
        $unsafe1 = "sun.misc.Unsafe" nocase
        $unsafe2 = "allocateMemory" nocase
        $unsafe3 = "putAddress" nocase
        $unsafe4 = "defineClass" nocase
        
    condition:
        $unsafe1 and any of ($unsafe2,$unsafe3,$unsafe4)
}

// ============================================================================
// C/C++ MALWARE PATTERNS
// ============================================================================

rule windows_process_injection {
    meta:
        description = "Detects Windows process injection techniques"
        severity = "critical"
        category = "process_injection"
        
    strings:
        $api1 = "CreateRemoteThread" nocase
        $api2 = "VirtualAllocEx" nocase
        $api3 = "WriteProcessMemory" nocase
        $api4 = "OpenProcess" nocase
        
    condition:
        3 of them
}

rule linux_process_injection {
    meta:
        description = "Detects Linux/Unix process injection"
        severity = "critical"
        category = "process_injection"
        
    strings:
        $ptrace1 = "ptrace" nocase
        $ptrace2 = "PTRACE_ATTACH" nocase
        $ptrace3 = "PTRACE_POKETEXT" nocase
        
        $preload1 = "LD_PRELOAD" nocase
        $preload2 = "LD_LIBRARY_PATH" nocase
        
    condition:
        (2 of ($ptrace*)) or (any of ($preload*))
}

rule unsafe_c_functions {
    meta:
        description = "Detects use of unsafe C functions"
        severity = "medium"
        category = "buffer_overflow"
        
    strings:
        $unsafe1 = "gets(" nocase
        $unsafe2 = "strcpy(" nocase
        $unsafe3 = "sprintf(" nocase
        $unsafe4 = "strcat(" nocase
        
        $exec1 = "system(" nocase
        $exec2 = "execve" nocase
        
    condition:
        (2 of ($unsafe*)) and (any of ($exec*))
}

// ============================================================================
// PHP MALWARE PATTERNS
// ============================================================================

rule php_webshell {
    meta:
        description = "Detects PHP webshell patterns"
        severity = "critical"
        category = "webshell"
        
    strings:
        $php = "<?php"
        
        $exec1 = "eval($_" nocase
        $exec2 = "system($_" nocase
        $exec3 = "exec($_" nocase
        $exec4 = "shell_exec($_" nocase
        $exec5 = "passthru($_" nocase
        $exec6 = "assert($_" nocase
        
        $decode = "base64_decode" nocase
        
    condition:
        $php and ((any of ($exec*)) or ($decode and any of ($exec*)))
}

rule php_backdoor {
    meta:
        description = "Detects PHP backdoor patterns"
        severity = "critical"
        category = "backdoor"
        
    strings:
        $create1 = "create_function" nocase
        $create2 = "preg_replace" nocase
        
        $eval = "eval(" nocase
        $assert = "assert(" nocase
        
        $encode1 = "base64_decode" nocase
        $encode2 = "gzinflate" nocase
        $encode3 = "str_rot13" nocase
        
    condition:
        (any of ($create*)) and ($eval or $assert) and (any of ($encode*))
}

// ============================================================================
// POWERSHELL MALWARE PATTERNS
// ============================================================================

rule powershell_download_execute {
    meta:
        description = "Detects PowerShell download and execute pattern"
        severity = "high"
        category = "downloader"
        
    strings:
        $download1 = "Invoke-WebRequest" nocase
        $download2 = "DownloadString" nocase
        $download3 = "Net.WebClient" nocase
        
        $exec1 = "Invoke-Expression" nocase
        $exec2 = "IEX" nocase
        $exec3 = "Start-Process" nocase
        
    condition:
        (any of ($download*)) and (any of ($exec*))
}

rule powershell_encoded_command {
    meta:
        description = "Detects PowerShell encoded command execution"
        severity = "high"
        category = "obfuscation"
        
    strings:
        $encoded1 = "-EncodedCommand" nocase
        $encoded2 = "-enc" nocase
        
        $convert1 = "FromBase64String" nocase
        $convert2 = "Convert" nocase
        
    condition:
        any of ($encoded*) or (any of ($convert*))
}

// ============================================================================
// RUBY MALWARE PATTERNS
// ============================================================================

rule ruby_command_execution {
    meta:
        description = "Detects Ruby command execution patterns"
        severity = "high"
        category = "code_execution"
        
    strings:
        $exec1 = "system(" nocase
        $exec2 = "exec(" nocase
        $exec3 = "IO.popen" nocase
        $exec4 = "Kernel.eval" nocase
        
        $shell1 = "sh -c" nocase
        $shell2 = "bash -c" nocase
        $shell3 = "cmd /c" nocase
        
    condition:
        (any of ($exec*)) and (any of ($shell*))
}

// ============================================================================
// GO MALWARE PATTERNS
// ============================================================================

rule go_command_execution {
    meta:
        description = "Detects Go command execution patterns"
        severity = "high"
        category = "code_execution"
        
    strings:
        $import1 = "os/exec" nocase
        $import2 = "syscall" nocase
        
        $exec1 = "exec.Command" nocase
        $exec2 = "syscall.Exec" nocase
        $exec3 = "syscall.ForkExec" nocase
        
    condition:
        (any of ($import*)) and (any of ($exec*))
}

// ============================================================================
// RUST MALWARE PATTERNS
// ============================================================================

rule rust_unsafe_operations {
    meta:
        description = "Detects Rust unsafe operations"
        severity = "medium"
        category = "unsafe_code"
        
    strings:
        $unsafe1 = "unsafe {" nocase
        $unsafe2 = "std::ptr::" nocase
        $unsafe3 = "std::mem::transmute" nocase
        
        $libc1 = "libc::system" nocase
        $libc2 = "libc::execve" nocase
        
    condition:
        (any of ($unsafe*)) and (any of ($libc*))
}

// ============================================================================
// SQL INJECTION PATTERNS
// ============================================================================

rule sql_injection_attempts {
    meta:
        description = "Detects SQL injection patterns"
        severity = "high"
        category = "injection"
        
    strings:
        $sqli1 = "UNION SELECT" nocase
        $sqli2 = "' OR '1'='1" nocase
        $sqli3 = "' OR 1=1" nocase
        $sqli4 = "'; DROP TABLE" nocase
        $sqli5 = "xp_cmdshell" nocase
        
    condition:
        any of them
}

